<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>READY BALL ELITE - OPTIMIZED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@600;700&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #050510; font-family: 'Rajdhani', sans-serif; touch-action: none; user-select: none; }
        
        #ui { position: absolute; top: 5%; width: 100%; text-align: center; color: #0ff; text-shadow: 0 0 20px #0ff; pointer-events: none; z-index: 10; }
        #score { font-size: clamp(40px, 10vw, 80px); font-weight: 900; font-family: 'Orbitron', sans-serif; line-height: 1; }
        #high-score { font-size: clamp(10px, 2vw, 16px); color: #f0f; text-transform: uppercase; letter-spacing: 3px; margin-top: 5px; opacity: 0.8; }

        .full-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 2000; cursor: pointer; pointer-events: auto;
            box-sizing: border-box; padding: 20px;
        }
        #overlay { background: #000; }
        #gameover { background: rgba(5, 5, 20, 0.98); display: none; z-index: 3000; overflow-y: auto; }
        
        .gameover-box {
            background: rgba(10, 10, 30, 0.95); padding: clamp(15px, 4vw, 30px); border: 2px solid #0ff;
            color: #fff; text-align: center; border-radius: 25px;
            box-shadow: 0 0 50px rgba(0,255,255,0.2); width: 100%; max-width: 340px;
            margin: auto;
        }
        
        #final-score { font-size: clamp(40px, 8vw, 60px); font-weight: 900; margin: 5px 0; font-family: 'Orbitron'; color: #fff; }
        
        .leaderboard { margin: 10px 0; text-align: left; background: #000; padding: 8px; border-radius: 10px; border: 1px solid #222; }
        .leaderboard h3 { margin-top: 0; color: #0ff; text-align: center; border-bottom: 1px solid #222; padding-bottom: 5px; font-size: 12px; text-transform: uppercase; }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #111; font-size: 12px; }
        
        .save-form { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .save-form input { padding: 10px; background: #111; border: 1px solid #333; color: #fff; font-size: 14px; border-radius: 8px; text-align: center; }
        .save-form button { padding: 10px; background: #0ff; color: #000; border: none; cursor: pointer; font-weight: 900; font-family: 'Orbitron'; font-size: 12px; border-radius: 8px; }
        
        .btn-group { display: flex; gap: 8px; margin-top: 10px; width: 100%; }
        .btn-small { flex: 1; padding: 12px; background: transparent; color: #fff; border: 1px solid #fff; cursor: pointer; font-family: 'Orbitron'; border-radius: 8px; font-size: 11px; }

        #start-hint { position: absolute; bottom: 15%; width: 100%; text-align: center; color: #0ff; font-family: 'Orbitron'; font-size: 14px; letter-spacing: 2px; animation: blink 1s infinite; display: none; z-index: 50; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* Landscape orientation fixes */
        @media (orientation: landscape) and (max-height: 500px) {
            .gameover-box { transform: scale(0.85); padding: 15px; }
            #final-score { font-size: 40px; }
            .leaderboard-list { max-height: 70px; }
            #ui { top: 2%; }
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="score">0</div>
        <div id="high-score">READY BEST: 0</div>
    </div>
    <div id="start-hint">TAP TO KICK OFF!</div>

    <div id="overlay" class="full-overlay">
        <div style="font-family: 'Orbitron'; color: #0ff; font-size: 10px; letter-spacing: 4px; margin-bottom: 10px;">READY FC</div>
        <h1 style="color: #fff; font-size: clamp(30px, 8vw, 50px); font-family: 'Orbitron'; text-shadow: 0 0 30px #0ff; margin: 0; font-weight: 900;">READY BALL</h1>
        <div style="margin-top: 40px; color: #0ff; border: 1px solid #0ff; padding: 12px 30px; border-radius: 50px; font-weight: bold; font-family: 'Orbitron'; font-size: 14px;">BẤM RA SÂN</div>
    </div>

    <div id="gameover" class="full-overlay">
        <div class="gameover-box">
            <h2 style="color: #f00; font-family: 'Orbitron'; margin: 0; font-size: 24px; font-weight: 900;">CRASHED</h2>
            <div id="final-score">0</div>
            <div class="leaderboard">
                <h3>BẢNG XẾP HẠNG</h3>
                <ul id="leaderboard-list" class="leaderboard-list"></ul>
            </div>
            <div id="save-section" class="save-form">
                <input type="text" id="player-name" placeholder="TÊN..." maxlength="12">
                <button id="save-btn">GHI DANH</button>
            </div>
            <div class="btn-group">
                <button class="btn-small" id="retry-btn">LÀM LẠI</button>
                <button class="btn-small" id="list-btn" style="border-color:#0ff; color:#0ff;">GAMES</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMdRK3n6-e1LCXHJmz8i80InZdmACzM34C1GUvd0IBItwdL8iMJNfdHqYX-9jCR4Qb/exec';
        let audio, scene, camera, renderer, ball, obstacles = [];
        let score = 0, speed = 0.14, isGameOver = false, gameStarted = false;
        let ballYVel = 0, gravity = -0.01, lift = 0.24, gapHeight = 5.5;

        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('start-hint').style.display = 'block';
            if(!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
            animate();
        }

        // --- AUDIO ---
        function playSfx(f1, f2, dur, type='triangle') {
            if(!audio) return;
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = type; o.frequency.setValueAtTime(f1, audio.currentTime);
            o.frequency.exponentialRampToValueAtTime(f2, audio.currentTime + dur);
            g.gain.setValueAtTime(0.2, audio.currentTime); g.gain.linearRampToValueAtTime(0, audio.currentTime + dur);
            o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime + dur);
        }

        document.getElementById('overlay').addEventListener('click', startGame);
        document.getElementById('overlay').addEventListener('touchstart', (e) => { e.preventDefault(); startGame(); }, { passive: false });
        document.getElementById('retry-btn').addEventListener('click', () => location.reload());
        document.getElementById('list-btn').addEventListener('click', () => location.href='../../games.html');
        document.getElementById('save-btn').addEventListener('click', saveScore);

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050510, 0.03);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            updateCameraPosition();

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const mainLight = new THREE.DirectionalLight(0x00ffff, 1.2); mainLight.position.set(5, 10, 10); scene.add(mainLight);

            createBall();
            const best = localStorage.getItem('ready_flappy_elite_best') || 0;
            document.getElementById('high-score').innerText = `BEST: ${best}`;
            
            const handleAction = (e) => { 
                if (isGameOver || document.getElementById('overlay').style.display !== 'none') return;
                if (!gameStarted) { gameStarted = true; document.getElementById('start-hint').style.display = 'none'; }
                ballYVel = lift; playSfx(150, 60, 0.1);
                if (e && e.cancelable) e.preventDefault();
            };
            window.addEventListener('mousedown', handleAction);
            window.addEventListener('touchstart', handleAction, { passive: false });
            spawnObstacles();
        }

        function updateCameraPosition() {
            // Adjust FOV and Z based on orientation to keep ball in view
            const aspect = window.innerWidth / window.innerHeight;
            camera.aspect = aspect;
            if (aspect < 1) { // Portrait
                camera.position.set(0, 0, 18);
                camera.fov = 85;
            } else { // Landscape
                camera.position.set(0, 0, 12);
                camera.fov = 65;
            }
            camera.updateProjectionMatrix();
            camera.lookAt(0, 0, 0);
        }

        function createBall() {
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 256; const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,256,256);
            ctx.fillStyle = '#111'; for(let i=0; i<6; i++) { ctx.beginPath(); ctx.arc(Math.random()*256, Math.random()*256, 30, 0, Math.PI*2); ctx.fill(); }
            ctx.fillStyle = '#0ff'; ctx.font = 'bold 50px Orbitron'; ctx.textAlign = 'center'; ctx.fillText('READY', 128, 145);
            const tex = new THREE.CanvasTexture(canvas);
            ball = new THREE.Mesh(new THREE.SphereGeometry(0.6, 32, 32), new THREE.MeshPhongMaterial({ map: tex, emissive: 0x00ffff, emissiveIntensity: 0.1 }));
            ball.position.set(-5, 0, 0); scene.add(ball);
        }

        function spawnObstacles() { for(let i=0; i<4; i++) { createGate(i * 18 + 20); } }

        function createGate(xPos) {
            const group = new THREE.Group(); const h = (Math.random() - 0.5) * 8;
            const gateMat = new THREE.MeshPhongMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.5 });
            const createPart = (yPos, isTop) => {
                const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 25, 12), gateMat);
                beam.position.y = yPos; return beam;
            };
            group.add(createPart(h + gapHeight/2 + 12.5, true));
            group.add(createPart(h - gapHeight/2 - 12.5, false));
            group.position.x = xPos; group.userData = { passed: false, h: h };
            scene.add(group); obstacles.push(group);
        }

        function animate() {
            if (isGameOver) return;
            requestAnimationFrame(animate);
            if (gameStarted) {
                ballYVel += gravity; ball.position.y += ballYVel; ball.rotation.z -= 0.15;
                if (ball.position.y > 12 || ball.position.y < -12) gameOver();
                speed += 0.00003;
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    obstacles[i].position.x -= speed;
                    if (Math.abs(ball.position.x - obstacles[i].position.x) < 1.2) {
                        const h = obstacles[i].userData.h;
                        if (ball.position.y > h + gapHeight/2 - 0.5 || ball.position.y < h - gapHeight/2 + 0.5) gameOver();
                    }
                    if (!obstacles[i].userData.passed && obstacles[i].position.x < ball.position.x) {
                        obstacles[i].userData.passed = true; score++; document.getElementById('score').innerText = score; playSfx(523, 1046, 0.1);
                    }
                    if (obstacles[i].position.x < -20) {
                        obstacles[i].position.x = 52; obstacles[i].userData.passed = false; const newH = (Math.random() - 0.5) * 8; obstacles[i].userData.h = newH;
                        obstacles[i].children[0].position.y = newH + gapHeight/2 + 12.5; obstacles[i].children[1].position.y = newH - gapHeight/2 - 12.5;
                    }
                }
            }
            renderer.render(scene, camera);
        }

        function gameOver() {
            isGameOver = true; playSfx(100, 20, 0.5, 'sawtooth');
            document.getElementById('final-score').innerText = score;
            document.getElementById('gameover').style.display = 'flex';
            const best = localStorage.getItem('ready_flappy_elite_best') || 0;
            if (score > best) { localStorage.setItem('ready_flappy_elite_best', score); document.getElementById('high-score').innerText = `BEST: ${score}`; }
            displayLeaderboard();
        }

        async function saveScore() {
            const name = document.getElementById('player-name').value.trim().toUpperCase() || 'ANONYMOUS';
            const btn = document.getElementById('save-btn'); btn.disabled = true; btn.innerText = '...';
            try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name, score }) }); document.getElementById('save-section').style.display = 'none'; setTimeout(displayLeaderboard, 1000); }
            catch (e) { btn.disabled = false; btn.innerText = 'THỬ LẠI'; }
        }
        async function displayLeaderboard() {
            const list = document.getElementById('leaderboard-list'); list.innerHTML = '<li style="text-align:center;font-size:10px;color:#0ff;">LOADING...</li>';
            try { 
                const res = await fetch(SCRIPT_URL, { method: 'GET', redirect: 'follow' }); const board = await res.json();
                list.innerHTML = board.map((item, index) => `<li class="leaderboard-item"><span class="name">${index + 1}. ${item.name}</span><span class="points">${item.score}</span></li>`).join('');
            } catch (e) { list.innerHTML = '<li>LỖI TẢI BXH</li>'; }
        }

        window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); updateCameraPosition(); });
        init();
    </script>
</body>
</html>
